// ===================================
// GOOGLE APPS SCRIPT - H·ªÜ TH·ªêNG THANH TO√ÅN T·ª∞ ƒê·ªòNG V·ªöI PAYOS
// ===================================

var CONFIG = {
  EMAIL_FROM: 'nht194@gmail.com',
  SHEET_NAME: 'Orders',
  LICENSE_SHEET_NAME: 'LicenseKeys',
  PAYOS_CLIENT_ID: 'dbe2f5ab-91c1-4532-8425-1e366cf7572f',
  PAYOS_API_KEY: '7c5d77ce-b35b-4826-8328-d4f2e0aa7d67',
  PAYOS_CHECKSUM_KEY: '6899e3509d19e24ec9d59fd6a84192d24f64bc433d608afd50244339030b2d67',
};

// ===================================
// HMAC-SHA256 SIGNATURE
// ===================================

function createSignature(data) {
  var signData = 'amount=' + data.amount + '&cancelUrl=' + data.cancelUrl + '&description=' + data.description + '&orderCode=' + data.orderCode + '&returnUrl=' + data.returnUrl;
  var signatureBytes = Utilities.computeHmacSha256Signature(signData, CONFIG.PAYOS_CHECKSUM_KEY);
  var hex = '';
  for (var i = 0; i < signatureBytes.length; i++) {
    var byte = signatureBytes[i];
    if (byte < 0) byte += 256;
    var hexByte = byte.toString(16);
    if (hexByte.length === 1) hexByte = '0' + hexByte;
    hex += hexByte;
  }
  return hex;
}

// ===================================
// T·∫†O PAYMENT LINK PAYOS
// ===================================

function createPaymentLink(orderData) {
  try {
    var url = 'https://api-merchant.payos.vn/v2/payment-requests';
    var orderCodeNumber = parseInt(orderData.orderCode);
    if (isNaN(orderCodeNumber) || orderCodeNumber <= 0) {
      return { success: false, error: 'M√£ ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá' };
    }
    
    var returnUrl = 'https://packrecordpro.com/payment-success';
    var cancelUrl = 'https://packrecordpro.com/payment-cancel';
    var description = 'DH' + orderData.orderCode;
    
    var signature = createSignature({
      amount: orderData.amount, cancelUrl: cancelUrl,
      description: description, orderCode: orderCodeNumber, returnUrl: returnUrl
    });
    
    var payload = {
      orderCode: orderCodeNumber, amount: orderData.amount,
      description: description, returnUrl: returnUrl,
      cancelUrl: cancelUrl, signature: signature
    };
    
    var options = {
      method: 'post', contentType: 'application/json',
      headers: { 'x-client-id': CONFIG.PAYOS_CLIENT_ID, 'x-api-key': CONFIG.PAYOS_API_KEY },
      payload: JSON.stringify(payload), muteHttpExceptions: true
    };
    
    var response = UrlFetchApp.fetch(url, options);
    var responseBody = JSON.parse(response.getContentText());
    Logger.log('payOS Response: ' + JSON.stringify(responseBody));
    
    if (response.getResponseCode() === 200 && responseBody.code === '00') {
      return {
        success: true,
        checkoutUrl: responseBody.data.checkoutUrl,
        qrCode: responseBody.data.qrCode
      };
    }
    return { success: false, error: responseBody.desc || 'payOS error' };
  } catch (error) {
    Logger.log('Error: ' + error);
    return { success: false, error: error.toString() };
  }
}

// ===================================
// doPost - WEBHOOK T·ª™ PAYOS
// ===================================

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    Logger.log('Webhook: ' + JSON.stringify(data));
    
    if (data.code === '00' && data.data) {
      var orderCode = data.data.description.replace('DH', '');
      processPayment(orderCode, data.data.amount);
      return ContentService.createTextOutput(JSON.stringify({ success: true })).setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({ success: false })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('doPost error: ' + error);
    return ContentService.createTextOutput(JSON.stringify({ success: false })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ===================================
// doGet - TR·∫¢ V·ªÄ HTML V·ªöI postMessage (BYPASS CORS)
// ===================================

function doGet(e) {
  try {
    if (!e || !e.parameter || !e.parameter.action) {
      return HtmlService.createHtmlOutput('<html><body>API Ready</body></html>');
    }
    
    var action = e.parameter.action;
    var result = {};
    
    if (action === 'create_order') {
      var orderCode = e.parameter.orderCode;
      var fullName = e.parameter.fullName;
      var email = e.parameter.email;
      var phone = e.parameter.phone;
      var pkg = e.parameter['package'];
      var amount = parseInt(e.parameter.amount);
      
      if (!orderCode || !fullName || !email || !phone || !pkg || isNaN(amount)) {
        result = { success: false, error: 'Thi·∫øu th√¥ng tin' };
      } else {
        var orderData = {
          orderCode: orderCode, fullName: fullName, email: email, phone: phone,
          package: pkg, amount: amount, status: 'Ch·ªù thanh to√°n', timestamp: new Date().toISOString()
        };
        
        Logger.log('Creating order: ' + JSON.stringify(orderData));
        saveOrder(orderData);
        
        var paymentResult = createPaymentLink(orderData);
        if (paymentResult.success) {
          result = { success: true, orderCode: orderCode, checkoutUrl: paymentResult.checkoutUrl, qrCode: paymentResult.qrCode };
        } else {
          result = { success: false, error: paymentResult.error };
        }
      }
    } else if (action === 'verify_license') {
      // Verify v·∫´n tr·∫£ JSON b√¨nh th∆∞·ªùng (g·ªçi t·ª´ C# app, kh√¥ng c√≥ CORS issue)
      return verifyLicense(e.parameter.licenseKey);
    } else {
      result = { success: false, error: 'Invalid action' };
    }
    
    // Tr·∫£ HTML ch·ª©a postMessage - bypass CORS
    var html = '<!DOCTYPE html><html><body><script>'
      + 'var data = ' + JSON.stringify(result) + ';'
      + 'if (window.parent && window.parent !== window) {'
      + '  window.parent.postMessage({type: "GAS_RESPONSE", data: data}, "*");'
      + '}'
      + '</script></body></html>';
    
    return HtmlService.createHtmlOutput(html)
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
    
  } catch (error) {
    Logger.log('doGet error: ' + error);
    var errorHtml = '<!DOCTYPE html><html><body><script>'
      + 'window.parent.postMessage({type: "GAS_RESPONSE", data: {success: false, error: "' + error.toString().replace(/"/g, '\\"') + '"}}, "*");'
      + '</script></body></html>';
    return HtmlService.createHtmlOutput(errorHtml)
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
}

// ===================================
// L∆ØU ƒê∆†N H√ÄNG
// ===================================

function saveOrder(data) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(CONFIG.SHEET_NAME);
    sheet.appendRow(['M√£ ƒêH', 'H·ªç T√™n', 'Email', 'SƒêT', 'G√≥i', 'Gi√°', 'Tr·∫°ng Th√°i', 'License Key', 'Ng√†y H·∫øt H·∫°n', 'Th·ªùi Gian ƒê·∫∑t', 'Ghi Ch√∫']);
    sheet.getRange(1, 1, 1, 11).setBackground('#21A691').setFontColor('#FFFFFF').setFontWeight('bold');
  }
  sheet.appendRow([data.orderCode, data.fullName, data.email, data.phone, data.package, data.amount, data.status, '', '', data.timestamp, '']);
}

// ===================================
// X·ª¨ L√ù THANH TO√ÅN (t·ª´ webhook)
// ===================================

function processPayment(orderCode, paidAmount) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
  if (!sheet) return;
  var data = sheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(orderCode) && data[i][6] === 'Ch·ªù thanh to√°n') {
      var email = data[i][2], fullName = data[i][1], packageName = data[i][4], amount = data[i][5];
      if (paidAmount >= amount) {
        var licenseKey = generateLicenseKey(packageName);
        var expiryDate = calculateExpiryDate(packageName);
        sheet.getRange(i + 1, 7).setValue('ƒê√£ thanh to√°n ‚úÖ');
        sheet.getRange(i + 1, 8).setValue(licenseKey);
        sheet.getRange(i + 1, 9).setValue(expiryDate);
        sheet.getRange(i + 1, 11).setValue('Auto: ' + new Date().toLocaleString('vi-VN'));
        saveLicenseKey(licenseKey, String(orderCode), packageName, email, expiryDate);
        sendLicenseEmail(email, fullName, licenseKey, packageName, expiryDate);
        Logger.log('‚úÖ Processed: ' + orderCode + ' ‚Üí ' + licenseKey);
      }
      break;
    }
  }
}

// ===================================
// LICENSE KEY
// ===================================

function generateLicenseKey(packageName) {
  var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  var prefix = (packageName.indexOf('Tr·ªçn ƒê·ªùi') >= 0 || packageName.indexOf('Lifetime') >= 0) ? 'ANVP-' : 'ANVI-';
  var key = prefix;
  for (var i = 0; i < 3; i++) {
    for (var j = 0; j < 4; j++) key += chars.charAt(Math.floor(Math.random() * chars.length));
    if (i < 2) key += '-';
  }
  return key;
}

function calculateExpiryDate(packageName) {
  if (packageName.indexOf('Tr·ªçn ƒê·ªùi') >= 0 || packageName.indexOf('Lifetime') >= 0) return 'Tr·ªçn ƒë·ªùi';
  return new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toLocaleDateString('vi-VN');
}

function saveLicenseKey(licenseKey, orderCode, packageName, email, expiryDate) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(CONFIG.LICENSE_SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(CONFIG.LICENSE_SHEET_NAME);
    sheet.appendRow(['License Key', 'M√£ ƒêH', 'G√≥i', 'Email', 'Ng√†y K√≠ch Ho·∫°t', 'Ng√†y H·∫øt H·∫°n', 'Tr·∫°ng Th√°i']);
    sheet.getRange(1, 1, 1, 7).setBackground('#87DF2C').setFontColor('#000000').setFontWeight('bold');
  }
  sheet.appendRow([licenseKey, orderCode, packageName, email, new Date().toLocaleString('vi-VN'), expiryDate, 'ƒê√£ g·ª≠i']);
}

// ===================================
// G·ª¨I EMAIL
// ===================================

function sendLicenseEmail(email, fullName, licenseKey, packageName, expiryDate) {
  var isLifetime = packageName.indexOf('Tr·ªçn ƒê·ªùi') >= 0 || packageName.indexOf('Lifetime') >= 0;
  var packageIcon = isLifetime ? 'üëë' : '‚≠ê';
  var expiryText = isLifetime ? '<strong style="color:#87DF2C">Tr·ªçn ƒë·ªùi</strong>' : '<strong>' + expiryDate + '</strong>';
  
  var htmlBody = '<!DOCTYPE html><html><head><style>'
    + 'body{font-family:Arial,sans-serif;line-height:1.6;color:#333}'
    + '.container{max-width:600px;margin:0 auto;padding:20px}'
    + '.header{background:linear-gradient(135deg,#21A691,#87DF2C);color:#fff;padding:30px;text-align:center;border-radius:10px 10px 0 0}'
    + '.content{background:#f9f9f9;padding:30px;border-radius:0 0 10px 10px}'
    + '.license-box{background:#fff;border:2px dashed #21A691;padding:20px;margin:20px 0;text-align:center;border-radius:8px}'
    + '.license-key{font-size:28px;font-weight:bold;color:#21A691;letter-spacing:2px;font-family:monospace}'
    + '</style></head><body><div class="container">'
    + '<div class="header"><h1 style="margin:0">üì¶ PackRecord Pro</h1></div>'
    + '<div class="content">'
    + '<p>Xin ch√†o <strong>' + fullName + '</strong>,</p>'
    + '<p>C·∫£m ∆°n b·∫°n ƒë√£ mua <strong>' + packageIcon + ' ' + packageName + '</strong>.</p>'
    + '<div class="license-box"><p style="color:#666">License Key:</p><div class="license-key">' + licenseKey + '</div></div>'
    + '<p><strong>H·∫°n s·ª≠ d·ª•ng:</strong> ' + expiryText + '</p>'
    + '<p><strong>H·ªó tr·ª£:</strong> Zalo 0912026236 (Mr. Th√°i) | 0963610986 (Ms. Quy√™n)</p>'
    + '</div></div></body></html>';
  
  MailApp.sendEmail({ to: email, subject: 'üéâ License Key PackRecord Pro', htmlBody: htmlBody });
  Logger.log('Email sent to: ' + email);
}

// ===================================
// VERIFY LICENSE (tr·∫£ JSON - d√πng cho C# app)
// ===================================

function verifyLicense(licenseKey) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(CONFIG.LICENSE_SHEET_NAME);
    if (!sheet) return ContentService.createTextOutput(JSON.stringify({ valid: false })).setMimeType(ContentService.MimeType.JSON);
    
    var data = sheet.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) {
      if (data[i][0] === licenseKey) {
        var expiryDate = data[i][5];
        var isExpired = false, daysRemaining = -1;
        if (expiryDate !== 'Tr·ªçn ƒë·ªùi' && expiryDate !== '') {
          var parts = expiryDate.split('/');
          if (parts.length === 3) {
            var expiry = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            isExpired = expiry < new Date();
            if (!isExpired) daysRemaining = Math.ceil((expiry - new Date()) / 86400000);
          }
        }
        return ContentService.createTextOutput(JSON.stringify({
          valid: true, licenseKey: licenseKey, package: data[i][2],
          email: data[i][3], activationDate: data[i][4], expiryDate: expiryDate,
          isLifetime: expiryDate === 'Tr·ªçn ƒë·ªùi', isExpired: isExpired, daysRemaining: daysRemaining
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    return ContentService.createTextOutput(JSON.stringify({ valid: false, error: 'License key not found' })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ valid: false, error: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ===================================
// TH·ª¶ C√îNG + TEST
// ===================================

function manualProcessAllPending() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
  if (!sheet) return;
  var data = sheet.getDataRange().getValues();
  var processed = 0;
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][6] === 'Ch·ªù thanh to√°n') {
      var licenseKey = generateLicenseKey(data[i][4]);
      var expiryDate = calculateExpiryDate(data[i][4]);
      sheet.getRange(i + 1, 7).setValue('ƒê√£ thanh to√°n ‚úÖ');
      sheet.getRange(i + 1, 8).setValue(licenseKey);
      sheet.getRange(i + 1, 9).setValue(expiryDate);
      sheet.getRange(i + 1, 11).setValue('Th·ªß c√¥ng: ' + new Date().toLocaleString('vi-VN'));
      saveLicenseKey(licenseKey, String(data[i][0]), data[i][4], data[i][2], expiryDate);
      try { sendLicenseEmail(data[i][2], data[i][1], licenseKey, data[i][4], expiryDate); } catch(e) { Logger.log('Email error: ' + e); }
      Logger.log('‚úÖ ' + data[i][0] + ' ‚Üí ' + licenseKey + ' ‚Üí ' + data[i][2]);
      processed++;
    }
  }
  Logger.log('=== X·ª≠ l√Ω xong: ' + processed + ' ƒë∆°n ===');
}

function testCreateOrder() {
  var result = doGet({ parameter: { action: 'create_order', orderCode: '0210191530999', fullName: 'Test', email: 'nht194@gmail.com', phone: '0912026236', package: 'G√≥i 1 NƒÉm', amount: '499000' } });
  Logger.log('Result: ' + result.getContent());
}

function testWebhook() {
  var result = doPost({ postData: { contents: JSON.stringify({ code: '00', desc: 'success', data: { orderCode: 210191530999, amount: 499000, description: 'DH0210191530999', code: '00', desc: 'OK' }, signature: 'test' }) } });
  Logger.log('Webhook result: ' + result.getContent());
}

function requestPermission() {
  UrlFetchApp.fetch('https://httpbin.org/get');
  SpreadsheetApp.getActiveSpreadsheet();
  MailApp.sendEmail({ to: 'nht194@gmail.com', subject: 'Test Permission', htmlBody: 'OK' });
  Logger.log('All permissions OK!');
}
